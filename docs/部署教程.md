# Gin-Vue-Admin 完整部署教程

## 目录
1. [为什么单独运行vite命令找不到？](#1-为什么单独运行vite命令找不到)
2. [Vite是什么？](#2-vite是什么)
3. [生产环境部署步骤](#3-生产环境部署步骤)

---

## 1. 为什么单独运行vite命令找不到？

### 问题分析
- `npm run serve` 使用项目本地依赖（node_modules）里的 vite
- 在 bash 直接运行 `vite` 使用全局命令，全局未安装会报错

### 解决方案
```bash
# 方法1：使用npx（推荐）
npx vite --host --mode development

# 方法2：使用完整路径
./node_modules/.bin/vite --host --mode development

# 方法3：全局安装vite（不推荐，可能导致版本冲突）
npm install -g vite
```

---

## 2. Vite是什么？

### 核心概念
- **构建工具**：以 ES Modules 为核心，预构建常见依赖，启动快、热更新快
- **开发服务器**：秒开，响应快
- **生产构建**：使用 Rollup 打包，性能高

### 主要特点
- 快速冷启动：不打包即可运行，按需编译
- 热模块替换（HMR）：更新只编译改动，速度快
- 支持 TypeScript、Vue 3、React 等
- 默认开箱即用

### 开发模式 vs 生产模式
- 开发模式：`npm run serve`，本地服务器，支持热更新
- 生产模式：`npm run build`，生成静态文件（dist 目录）

---

## 3. 生产环境部署步骤

### 方案概述
在 Gin 服务中直接托管前端静态文件，一个服务同时提供前后端。

### 详细步骤

#### 步骤1：修改前端配置

创建并配置生产环境文件：

**1.1 创建 `web/.env.production` 文件**
```bash
cd web
touch .env.production
```

**1.2 编辑 `web/.env.production`**
```env
# 生产环境配置
VUE_APP_BASE_API=/
VUE_APP_BASE_PATH=http://your-domain.com
VITE_CLI_PORT=8080
VITE_SERVER_PORT=8888
```

**说明：**
- `VUE_APP_BASE_API=/` 不使用 API 路径前缀，直接根路径
- `VUE_APP_BASE_PATH` 改为生产域名或 IP
- `VITE_CLI_PORT` 前端端口（生产环境不常用）
- `VITE_SERVER_PORT` 后端服务端口

#### 步骤2：打包前端项目

```bash
# 进入前端目录
cd web

# 安装依赖（如果还没安装）
npm install

# 打包前端项目
npm run build
```

打包完成后会在 `web/dist` 目录生成静态文件：
- `index.html`
- `assets/`（JS、CSS）
- `favicon.ico`
- `logo.png`

#### 步骤3：修改后端路由配置

**3.1 打开 `server/initialize/router.go`**

**3.2 找到第58-64行，取消注释并修改：**
```go
// 原来的代码（注释状态）
// Router.StaticFile("/favicon.ico", "./dist/favicon.ico")
// Router.Static("/assets", "./dist/assets")
// Router.StaticFile("/", "./dist/index.html")

// 修改为：
Router.StaticFile("/favicon.ico", "./web/dist/favicon.ico")
Router.Static("/assets", "./web/dist/assets")   // dist里面的静态资源
Router.StaticFile("/", "./web/dist/index.html") // 前端网页入口页面
```

**重要说明：**
- 静态文件路径已更新为 `./web/dist/`（相对于 server 目录）
- 确保 `web/dist` 目录在正确位置包，性能高

**3.3 将复制前端构建产物（可选）**
- 将 dist 复制到 server 目录旁边，然后指向 `./dist/`

#### 步骤4：编译后端

**4.1 编译 Go 程序**
```bash
cd server

# 编译（Windows）
go build -o gmserver.exe main.go

# 编译（Linux/Mac）
go build -o gmserver main.go
```

**4.2 配置文件**
编辑 `server/config.yaml`：

```yaml
system:
  env: release          # 生产环境使用release
  addr: 8888            # 服务端口
  db-type: mysql        # 数据库类型
  router-prefix: /api   # API路由前缀
```

#### 步骤5：部署到服务器

**5.1 目录结构**
```
/project/
├── gmserver.exe          # 编译后的可执行文件
├── config.yaml           # 配置文件
├── web/
│   └── dist/             # 前端构建产物
│       ├── index.html
│       ├── assets/
│       └── ...
└── ...
```

**5.2 启动服务**

**Windows：**
```bash
gmserver.exe
```

**Linux/Mac：**
```bash
chmod +x gmserver
./gmserver
```

**5.3 后台运行（Linux）**
```bash
# 使用nohup
nohup ./gmserver > gmserver.log 2>&1 &

# 使用systemd（推荐）
# 创建服务文件 /etc/systemd/system/gva.service
```

**Systemd 配置示例：**
```ini
[Unit]
Description=Gin Vue Admin Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/project
ExecStart=/path/to/project/gmserver
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl enable gva.service
sudo systemctl start gva.service
```

#### 步骤6：验证部署

**6.1 访问前端**
打开浏览器访问：`http://your-server-ip:8888`

**6.2 检查 API**
访问 Swagger 文档：`http://your-server-ip:8888/api/swagger/index.html`

**6.3 健康检查**
```bash
curl http://your-server-ip:8888/api/health
```

---

## 测试环境 vs 生产环境

### 测试环境部署
- 使用同一流程，域名/IP 改为测试环境地址
- 可用测试数据库
- 开启调试日志

### 生产环境注意事项
1. 数据库：独立生产数据库
2. 安全性：HTTPS、JWT 安全、敏感信息加密
3. 性能：开启缓存、优化查询、CDN
4. 日志：统一日志收集
5. 监控：监控可用性与性能

### 配置对比

| 配置项 | 测试环境 | 生产环境 |
|--------|---------|---------|
| env | debug | release |
| 数据库 | 测试库 | 生产库 |
| 日志级别 | debug | info/warn |
| HTTPS | 可选 | 必须 |

---

## 常见问题

### Q1: 前端页面404？
- 确保 router.go 中的静态文件路径正确
- 确认 dist 文件已生成
- 确认访问路径正确（根路径 /）

### Q2: API请求失败？
- 检查 `config.yaml` 端口
- 查看后端日志
- 核对 API 路径前缀

### Q3: 静态资源加载失败？
- 确认 `Router.Static` 路径正确
- 检查文件权限
- 核对 base 路径配置

### Q4: 跨域问题？
- 在 `router.go` 启用 CORS 中间件：
```go
Router.Use(middleware.Cors())
```

---

## 完整部署检查清单

- [ ] 前端 .env.production 配置
- [ ] 运行 npm run build 成功
- [ ] 后端 router.go 配置静态文件
- [ ] 后端编译成功
- [ ] 配置文件正确
- [ ] 数据库连接成功
- [ ] 服务启动成功
- [ ] 前端页面可访问
- [ ] API 接口正常
- [ ] 登录功能测试通过

---

## 总结

该方案：
- 无需 Nginx
- 使用 Gin 托管前端
- 单服务提供前后端

优点：
- 简单：一套部署
- 统一：一个端口
- 灵活：易于扩展

通过以上步骤即可在测试和生产环境部署。


