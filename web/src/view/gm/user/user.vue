<template>
  <div>
    <warning-bar title="Ê≥®ÔºöGMÁÆ°ÁêÜ - Áé©ÂÆ∂ÁÆ°ÁêÜ" />
    <div class="gva-search-box">
      <el-form ref="searchForm" :inline="true" :model="searchInfo">
        <el-form-item label="UserID">
          <el-input v-model="searchInfo.userId" placeholder="Áé©ÂÆ∂UserID" />
        </el-form-item>
        <el-form-item label="PlayerID">
          <el-input v-model="searchInfo.playerId" placeholder="Áé©ÂÆ∂PlayerID" />
        </el-form-item>
        <el-form-item label="UniqueID">
          <el-input v-model="searchInfo.uniqueId" placeholder="Áé©ÂÆ∂UniqueID" />
        </el-form-item>
        <el-form-item label="ÊòµÁß∞">
          <el-input v-model="searchInfo.nickname" placeholder="Áé©ÂÆ∂ÊòµÁß∞" />
        </el-form-item>
        <el-form-item label="ÊúÄÂêéÁôªÂΩïÊó•Êúü">
          <template #label>
            <span>
              ÊúÄÂêéÁôªÂΩïÊó•Êúü
              <el-tooltip
                content="ÊêúÁ¥¢ËåÉÂõ¥ÊòØÂºÄÂßãÊó•ÊúüÔºàÂåÖÂê´ÔºâËá≥ÁªìÊùüÊó•ÊúüÔºàÂåÖÂê´ÔºâÔºåÂèØ‰ª•Âè™ÈÄâÊã©ÂºÄÂßãÊó•ÊúüÊàñÂè™ÈÄâÊã©ÁªìÊùüÊó•Êúü"
              >
                <el-icon><QuestionFilled /></el-icon>
              </el-tooltip>
            </span>
          </template>
          <el-date-picker
            v-model="searchInfo.startLoginTime"
            type="datetime"
            placeholder="ÁôªÂΩïÂºÄÂßãÊó∂Èó¥"
            :disabled-date="
              (time) =>
                searchInfo.endLoginTime
                  ? time.getTime() > searchInfo.endLoginTime.getTime()
                  : false
            "
            style="width: 200px"
          />
          <span style="margin: 0 8px; color: #606266;">‚Äî</span>
          <el-date-picker
            v-model="searchInfo.endLoginTime"
            type="datetime"
            placeholder="ÁôªÂΩïÁªìÊùüÊó∂Èó¥"
            :disabled-date="
              (time) =>
                searchInfo.startLoginTime
                  ? time.getTime() < searchInfo.startLoginTime.getTime()
                  : false
            "
            style="width: 200px"
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" icon="search" @click="onSubmit">
            Êü•ËØ¢
          </el-button>
          <el-button icon="refresh" @click="onReset"> ÈáçÁΩÆ </el-button>
        </el-form-item>
      </el-form>
    </div>
    <div class="gva-table-box">
      <el-table :data="tableData" row-key="user_id">
        <el-table-column
          align="left"
          label="PlayerID"
          min-width="130"
          prop="player_id"
        />
        <el-table-column
          align="left"
          label="UserID"
          min-width="120"
          prop="user_id"
        />
        <el-table-column
          align="left"
          label="UniqueID"
          min-width="120"
          prop="unique_id"
        />
        <el-table-column
          align="left"
          label="ÊòµÁß∞"
          min-width="150"
          prop="nickname"
        />
        <el-table-column
          align="left"
          label="Á≠âÁ∫ß"
          min-width="80"
          prop="lv"
        />
        <el-table-column
          align="left"
          label="ÊàòÂäõ"
          min-width="180"
          prop="power"
        />
        <el-table-column
          align="left"
          label="Âå∫Êúç"
          min-width="60"
          prop="area_id"
        />
        <el-table-column align="left" label="Ê≥®ÂÜåÊó∂Èó¥" min-width="180" prop="register_time_formatted" />
        <el-table-column align="left" label="ÊúÄÂêéÁôªÂΩïÊó∂Èó¥" min-width="180" prop="login_time_formatted" />
        <el-table-column align="left" label="Áé©ÂÆ∂Áä∂ÊÄÅ" min-width="200">
          <template #default="scope">
            <div class="status-container">
              <el-tag :type="scope.row.online ? 'success' : 'info'" size="small">
                {{ scope.row.online ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø' }}
              </el-tag>
              <el-tag 
                v-if="scope.row.ban_chat" 
                type="warning" 
                size="small" 
                style="margin-left: 4px;"
              >
                Â∑≤Á¶ÅË®Ä
              </el-tag>
              <el-tag 
                v-if="scope.row.ban_login" 
                type="danger" 
                size="small" 
                style="margin-left: 4px;"
              >
                Â∑≤Â∞ÅÂè∑
              </el-tag>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="Êìç‰Ωú" :min-width="appStore.operateMinWith" fixed="right">
          <template #default="scope">
            <el-button
              type="primary"
              link
              icon="view"
              @click="openPlayerDetail(scope.row.player_id)"
            >
              ËØ¶ÊÉÖ
            </el-button>
            <el-button
              :type="scope.row.ban_chat ? 'success' : 'warning'"
              link
              :icon="scope.row.ban_chat ? 'unlock' : 'lock'"
              @click="handleBanChat(scope.row)"
            >
              {{ scope.row.ban_chat ? 'Ëß£Èô§Á¶ÅË®Ä' : 'Á¶ÅË®Ä' }}
            </el-button>
            <el-button
              :type="scope.row.ban_login ? 'success' : 'danger'"
              link
              :icon="scope.row.ban_login ? 'unlock' : 'lock'"
              @click="handleBanLogin(scope.row)"
            >
              {{ scope.row.ban_login ? 'Ëß£Èô§Â∞ÅÂè∑' : 'Â∞ÅÂè∑' }}
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      <div class="gva-pagination">
        <el-pagination
          :current-page="page"
          :page-size="pageSize"
          :page-sizes="[10, 30, 50, 100]"
          :total="total"
          layout="total, sizes, prev, pager, next, jumper"
          @current-change="handleCurrentChange"
          @size-change="handleSizeChange"
        />
      </div>
    </div>
    
    <!-- Áé©ÂÆ∂ËØ¶ÊÉÖÂºπÁ™ó -->
    <PlayerDetail 
      v-model="showPlayerDetail" 
      :player-id="selectedPlayerId"
      @close="handlePlayerDetailClose"
    />

    <!-- Á¶ÅË®ÄÊó∂Èó¥ÈÄâÊã©ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="banChatDialogVisible"
      title="‚è∞ ËÆæÁΩÆÁ¶ÅË®ÄÊà™Ê≠¢Êó∂Èó¥"
      width="500px"
      align-center
      destroy-on-close
    >
      <div style="padding: 20px 0;">
        <el-form :model="banChatData" label-width="120px">
          <el-form-item label="Á¶ÅË®ÄÊà™Ê≠¢Êó∂Èó¥" required>
            <el-date-picker
              v-model="banChatData.expireTime"
              type="datetime"
              placeholder="ËØ∑ÈÄâÊã©Á¶ÅË®ÄÊà™Ê≠¢Êó∂Èó¥"
              style="width: 100%"
              :disabled-date="(time) => time.getTime() <= Date.now()"
            />
          </el-form-item>
        </el-form>
      </div>
      
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="banChatDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button 
            type="warning" 
            @click="submitBanChat"
            :disabled="!banChatData.expireTime"
          >
            <el-icon><Lock /></el-icon>
            Á°ÆÂÆöÁ¶ÅË®Ä
          </el-button>
        </div>
      </template>
    </el-dialog>

    <!-- Â∞ÅÂè∑Êó∂Èó¥ÈÄâÊã©ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="banLoginDialogVisible"
      title="üö´ ËÆæÁΩÆÂ∞ÅÂè∑Êà™Ê≠¢Êó∂Èó¥"
      width="500px"
      align-center
      destroy-on-close
    >
      <div style="padding: 20px 0;">
        <el-form :model="banLoginData" label-width="120px">
          <el-form-item label="Â∞ÅÂè∑Êà™Ê≠¢Êó∂Èó¥" required>
            <el-date-picker
              v-model="banLoginData.expireTime"
              type="datetime"
              placeholder="ËØ∑ÈÄâÊã©Â∞ÅÂè∑Êà™Ê≠¢Êó∂Èó¥"
              style="width: 100%"
              :disabled-date="(time) => time.getTime() <= Date.now()"
            />
          </el-form-item>
        </el-form>
      </div>
      
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="banLoginDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button 
            type="danger" 
            @click="submitBanLogin"
            :disabled="!banLoginData.expireTime"
          >
            <el-icon><Lock /></el-icon>
            Á°ÆÂÆöÂ∞ÅÂè∑
          </el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
  import { useGMUserStore } from '@/pinia/gm/user'
  import WarningBar from '@/components/warningBar/warningBar.vue'
  import PlayerDetail from './components/PlayerDetail.vue'

  import { ref, watch, onMounted } from 'vue'
  import { ElMessage, ElMessageBox } from 'element-plus'
  import { Lock } from '@element-plus/icons-vue'
  import { useAppStore } from "@/pinia";
  import { storeToRefs } from 'pinia'

  defineOptions({
    name: 'GMUser'
  })

  const appStore = useAppStore()
  const gmUserStore = useGMUserStore()

  // Áä∂ÊÄÅÂíågetters‰ΩøÁî®storeToRefsÂìçÂ∫îÂºèËß£ÊûÑ
  const { 
    userList: tableData, 
    total, 
    page, 
    pageSize, 
    searchInfo,
  } = storeToRefs(gmUserStore)

  // ÊñπÊ≥ïÁõ¥Êé•Ëß£ÊûÑ
  const {
    fetchUserList,
    resetSearchInfo,
    setPage,
    setPageSize
  } = gmUserStore


  // Áé©ÂÆ∂ËØ¶ÊÉÖÁõ∏ÂÖ≥
  const showPlayerDetail = ref(false)
  const selectedPlayerId = ref('')
  
  // ÊâìÂºÄÁé©ÂÆ∂ËØ¶ÊÉÖ
  const openPlayerDetail = (playerId) => {
    selectedPlayerId.value = playerId
    showPlayerDetail.value = true
  }
  
  // ÂÖ≥Èó≠Áé©ÂÆ∂ËØ¶ÊÉÖ
  const handlePlayerDetailClose = () => {
    showPlayerDetail.value = false
    selectedPlayerId.value = ''
  }

  // Á¶ÅË®ÄÁõ∏ÂÖ≥
  const banChatDialogVisible = ref(false)
  const banChatData = ref({
    expireTime: null,
    currentRow: null  // ‰øùÂ≠òÂΩìÂâçÊìç‰ΩúÁöÑË°åÊï∞ÊçÆ
  })

  // Â∞ÅÂè∑Áõ∏ÂÖ≥
  const banLoginDialogVisible = ref(false)
  const banLoginData = ref({
    expireTime: null,
    currentRow: null  // ‰øùÂ≠òÂΩìÂâçÊìç‰ΩúÁöÑË°åÊï∞ÊçÆ
  })

  const onSubmit = () => {
    setPage(1)
    fetchUserList()
  }

  const onReset = () => {
    resetSearchInfo()
    setPage(1)
    fetchUserList()
  }

  // ÂàÜÈ°µ
  const handleSizeChange = (val) => {
    setPageSize(val)
    fetchUserList()
  }

  const handleCurrentChange = (val) => {
    setPage(val)
    fetchUserList()
  }

  watch(
    () => tableData.value,
    (newValue, oldValue) => {
      console.log('tableData ÂèòÂåñ‰∫Ü')
      console.log('Êñ∞ÂÄº:', newValue)
      console.log('ÊóßÂÄº:', oldValue)
    }
  )

  const initPage = async () => {
    await fetchUserList()
  }

  onMounted(() => {
    initPage()
  })


  // Â§ÑÁêÜÁ¶ÅË®Ä/Ëß£Èô§Á¶ÅË®Ä
  const handleBanChat = (row) => {
    if (row.ban_chat) {
      // Ëß£Èô§Á¶ÅË®ÄÔºöÁõ¥Êé•Á°ÆËÆ§
      ElMessageBox.confirm(`Á°ÆÂÆöË¶ÅËß£Èô§ËØ•Áé©ÂÆ∂ÁöÑÁ¶ÅË®ÄÂêóÔºü`, 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }).then(() => {
        executeBanChat(row, null)
      }).catch(() => {})
    } else {
      // Á¶ÅË®ÄÔºöÊâìÂºÄÂØπËØùÊ°ÜÈÄâÊã©Êó∂Èó¥
      banChatData.value = {
        expireTime: null,
        currentRow: row  // ‰øùÂ≠òÂÆåÊï¥ÁöÑË°åÊï∞ÊçÆ
      }
      banChatDialogVisible.value = true
    }
  }

  // ÊâßË°åÁ¶ÅË®Ä/Ëß£Èô§Á¶ÅË®ÄÊìç‰Ωú
  const executeBanChat = async (row, expireTime) => {
    const action = row.ban_chat ? 'Ëß£Èô§Á¶ÅË®Ä' : 'Á¶ÅË®Ä'
    
    try {
      const params = {
        player_id: row.player_id,
        expire_time: expireTime
      }
      
      await gmUserStore.toggleBanChat(params)
      ElMessage.success(`${action}ÊàêÂäü`)
      
      // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÂπ∂ÈáçÁΩÆ
      banChatDialogVisible.value = false
      banChatData.value = { expireTime: null, currentRow: null }
      
      // Âà∑Êñ∞ÂàóË°®
      await fetchUserList()
    } catch (error) {
      ElMessage.error(error.message || `${action}Â§±Ë¥•`)
    }
  }

  // Êèê‰∫§Á¶ÅË®ÄÔºàÂ∏¶Êó∂Èó¥ÈÄâÊã©Ôºâ
  const submitBanChat = () => {
    if (!banChatData.value.expireTime) {
      ElMessage.warning('ËØ∑ÈÄâÊã©Á¶ÅË®ÄÊà™Ê≠¢Êó∂Èó¥')
      return
    }
    
    ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÁ¶ÅË®ÄËØ•Áé©ÂÆ∂ÂêóÔºü', 'ÊèêÁ§∫', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }).then(() => {
      // Áõ¥Êé•‰ΩøÁî®‰øùÂ≠òÁöÑË°åÊï∞ÊçÆÔºåÊó†ÈúÄÊûÑÈÄ† tempRow
      const expireTimestamp = Math.floor(new Date(banChatData.value.expireTime).getTime() / 1000)
      executeBanChat(banChatData.value.currentRow, expireTimestamp)
    }).catch(() => {})
  }

  // Â§ÑÁêÜÂ∞ÅÂè∑/Ëß£Èô§Â∞ÅÂè∑
  const handleBanLogin = (row) => {
    if (row.ban_login) {
      // Ëß£Èô§Â∞ÅÂè∑ÔºöÁõ¥Êé•Á°ÆËÆ§
      ElMessageBox.confirm(`Á°ÆÂÆöË¶ÅËß£Èô§ËØ•Áé©ÂÆ∂ÁöÑÂ∞ÅÂè∑ÂêóÔºü`, 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }).then(() => {
        executeBanLogin(row, null)
      }).catch(() => {})
    } else {
      // Â∞ÅÂè∑ÔºöÊâìÂºÄÂØπËØùÊ°ÜÈÄâÊã©Êó∂Èó¥
      banLoginData.value = {
        expireTime: null,
        currentRow: row  // ‰øùÂ≠òÂÆåÊï¥ÁöÑË°åÊï∞ÊçÆ
      }
      banLoginDialogVisible.value = true
    }
  }

  // ÊâßË°åÂ∞ÅÂè∑/Ëß£Èô§Â∞ÅÂè∑Êìç‰Ωú
  const executeBanLogin = async (row, expireTime) => {
    const action = row.ban_login ? 'Ëß£Èô§Â∞ÅÂè∑' : 'Â∞ÅÂè∑'
    
    try {
      const params = {
        player_id: row.player_id,
        expire_time: expireTime
      }
      
      await gmUserStore.toggleBanLogin(params)
      ElMessage.success(`${action}ÊàêÂäü`)
      
      // ÂÖ≥Èó≠ÂØπËØùÊ°ÜÂπ∂ÈáçÁΩÆ
      banLoginDialogVisible.value = false
      banLoginData.value = { expireTime: null, currentRow: null }
      
      // Âà∑Êñ∞ÂàóË°®
      await fetchUserList()
    } catch (error) {
      ElMessage.error(error.message || `${action}Â§±Ë¥•`)
    }
  }

  // Êèê‰∫§Â∞ÅÂè∑ÔºàÂ∏¶Êó∂Èó¥ÈÄâÊã©Ôºâ
  const submitBanLogin = () => {
    if (!banLoginData.value.expireTime) {
      ElMessage.warning('ËØ∑ÈÄâÊã©Â∞ÅÂè∑Êà™Ê≠¢Êó∂Èó¥')
      return
    }
    
    ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÂ∞ÅÂè∑ËØ•Áé©ÂÆ∂ÂêóÔºü', 'ÊèêÁ§∫', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }).then(() => {
      // Áõ¥Êé•‰ΩøÁî®‰øùÂ≠òÁöÑË°åÊï∞ÊçÆÔºåÊó†ÈúÄÊûÑÈÄ† tempRow
      const expireTimestamp = Math.floor(new Date(banLoginData.value.expireTime).getTime() / 1000)
      executeBanLogin(banLoginData.value.currentRow, expireTimestamp)
    }).catch(() => {})
  }

</script>

<style lang="scss">
  .status-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px;
  }
  
  .status-container .el-tag {
    margin: 0;
  }
</style>
